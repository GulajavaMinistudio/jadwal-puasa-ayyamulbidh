System.register([],function(t,e){"use strict";return{execute:function(){const e={TIME:{SECOND_IN_MS:1e3,MINUTE_IN_MS:6e4,HOUR_IN_MS:36e5,DAY_IN_MS:864e5},CACHE:{PRAYER_TIMES_MAX_AGE:864e5,HIJRI_DATE_MAX_AGE:864e5,DEFAULT_MAX_AGE:36e5},INTERVALS:{SECOND:1e3,PRAYER_COUNTDOWN_UPDATE:6e4,DATA_REFRESH:36e5},API:{BASE_URL:"https://api.aladhan.com/v1",DEFAULT_METHOD:99,TIMEOUT:1e4,KEMENAG_CUSTOM:{method:99,methodSettings:"20,null,18",tune:"2,2,0,3,2,8,0,3,0"}},AYYAMUL_BIDH:{DATES:[13,14,15],DAYS_PER_MONTH:3,MONTHS_PER_YEAR:12,TOTAL_DAYS_PER_YEAR:36},STORAGE_KEYS:{APP_CONFIG:"app_config",FASTING_DATA:"puasa_ayyamul_bidh",CACHE:"cache"},VALIDATION:{LATITUDE_MIN:-90,LATITUDE_MAX:90,LONGITUDE_MIN:-180,LONGITUDE_MAX:180,HIJRI_DAY_MIN:1,HIJRI_DAY_MAX:30,HIJRI_MONTH_MIN:1,HIJRI_MONTH_MAX:12,HIJRI_YEAR_MIN:1300,HIJRI_YEAR_MAX:1600,MAX_STREAK_CALCULATION:24},PRAYER_METHODS:[{value:99,label:"Kementerian Agama RI (Akurat - Recommended)",isCustom:!0},{value:20,label:"Kementerian Agama RI (Standard Aladhan)"},{value:3,label:"Muslim World League (MWL)"},{value:2,label:"Islamic Society of North America (ISNA)"},{value:5,label:"Egyptian General Authority of Survey"},{value:4,label:"Umm Al-Qura University, Makkah"},{value:1,label:"University of Islamic Sciences, Karachi"},{value:7,label:"Institute of Geophysics, University of Tehran"}]},a={validateHijriDate(t){if(!t||"object"!=typeof t)return{valid:!1,data:null,error:"Invalid hijri data structure"};const{day:a,month:r,year:i,monthName:n,formatted:s}=t,o=parseInt(a);if(isNaN(o)||o<e.VALIDATION.HIJRI_DAY_MIN||o>e.VALIDATION.HIJRI_DAY_MAX)return{valid:!1,data:null,error:`Invalid Hijri day: ${a}`};const h=parseInt(r);if(isNaN(h)||h<e.VALIDATION.HIJRI_MONTH_MIN||h>e.VALIDATION.HIJRI_MONTH_MAX)return{valid:!1,data:null,error:`Invalid Hijri month: ${r}`};const l=parseInt(i);return isNaN(l)||l<e.VALIDATION.HIJRI_YEAR_MIN||l>e.VALIDATION.HIJRI_YEAR_MAX?{valid:!1,data:null,error:`Invalid Hijri year: ${i}`}:"string"!=typeof n||""===n.trim()?{valid:!1,data:null,error:"Invalid month name"}:"string"!=typeof s||""===s.trim()?{valid:!1,data:null,error:"Invalid formatted date"}:{valid:!0,data:{day:o,month:h,monthName:this.sanitizeString(n),year:l,formatted:this.sanitizeString(s)},error:null}},validatePrayerTimings(t){if(!t||"object"!=typeof t)return{valid:!1,data:null,error:"Invalid timings structure"};const e=["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha","Imsak"],a={};for(const r of e){if(!t[r])return{valid:!1,data:null,error:`Missing ${r} time`};const e=String(t[r]);if(!this.isValidTimeFormat(e))return{valid:!1,data:null,error:`Invalid time format for ${r}: ${e}`};const i=e.replace(/\s*\([^)]*\)\s*$/,"").trim();a[r]=i}return t.Midnight&&this.isValidTimeFormat(String(t.Midnight))&&(a.Midnight=String(t.Midnight)),{valid:!0,data:a,error:null}},validateDateData(t){if(!t||"object"!=typeof t)return{valid:!1,data:null,error:"Invalid date structure"};const e={};if(t.gregorian){const a=t.gregorian;e.gregorian={date:this.sanitizeString(a.date||""),day:this.sanitizeString(a.day||""),month:this.sanitizeString(a.month?.en||""),year:this.sanitizeString(a.year||"")}}if(t.hijri){const a=t.hijri;e.hijri={date:this.sanitizeString(a.date||""),day:this.sanitizeString(a.day||""),month:{en:this.sanitizeString(a.month?.en||""),ar:this.sanitizeString(a.month?.ar||""),number:parseInt(a.month?.number)||0},year:this.sanitizeString(a.year||"")}}return t.readable&&(e.readable=this.sanitizeString(t.readable)),{valid:!0,data:e,error:null}},validateStorageData(t,e){if(!t||"object"!=typeof t)return{valid:!1,data:null,error:"Invalid storage data"};if(Object.prototype.hasOwnProperty.call(t,"__proto__")||Object.prototype.hasOwnProperty.call(t,"constructor")||Object.prototype.hasOwnProperty.call(t,"prototype"))return{valid:!1,data:null,error:"Potential prototype pollution detected"};switch(e){case"config":return this.validateConfigData(t);case"fasting":return this.validateFastingData(t);case"cache":return this.validateCacheData(t);default:return{valid:!0,data:this.deepClone(t),error:null}}},validateConfigData(t){const a={};if(t.location){if(a.location={},t.location.city&&(a.location.city=this.sanitizeString(t.location.city)),t.location.country&&(a.location.country=this.sanitizeString(t.location.country)),void 0!==t.location.latitude&&void 0!==t.location.longitude){const r=parseFloat(t.location.latitude),i=parseFloat(t.location.longitude);!isNaN(r)&&!isNaN(i)&&r>=e.VALIDATION.LATITUDE_MIN&&r<=e.VALIDATION.LATITUDE_MAX&&i>=e.VALIDATION.LONGITUDE_MIN&&i<=e.VALIDATION.LONGITUDE_MAX&&(a.location.latitude=r,a.location.longitude=i)}t.location.method&&(a.location.method=this.sanitizeString(t.location.method))}if(void 0!==t.prayer_method){const e=parseInt(t.prayer_method);isNaN(e)||(a.prayer_method=e)}return"boolean"==typeof t.first_time_setup&&(a.first_time_setup=t.first_time_setup),{valid:!0,data:a,error:null}},validateFastingData(t){const a={};for(const[r,i]of Object.entries(t))if(/^\d{4}-\d{2}$/.test(r)&&Array.isArray(i)){const t=i.filter(t=>"number"==typeof t&&e.AYYAMUL_BIDH.DATES.includes(t));t.length>0&&(a[r]=t)}return{valid:!0,data:a,error:null}},validateCacheData(t){const e={};for(const[a,r]of Object.entries(t))r&&"object"==typeof r&&r.timestamp&&"number"==typeof r.timestamp&&(e[a]={data:this.deepClone(r.data),timestamp:r.timestamp});return{valid:!0,data:e,error:null}},isValidTimeFormat(t){const e=String(t).replace(/\s*\([^)]*\)\s*$/,"").trim();return/^([0-1]?[0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/.test(e)},sanitizeString(t){if("string"!=typeof t)return"";const e=document.createElement("div");return e.textContent=String(t),e.innerHTML.trim()},deepClone(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(Array.isArray(t))return t.map(t=>this.deepClone(t));const e={};for(const a of Object.keys(t))"__proto__"!==a&&"constructor"!==a&&"prototype"!==a&&(e[a]=this.deepClone(t[a]));return e}},r=t("S",{save(t,e){try{const a=JSON.stringify(e);return localStorage.setItem(t,a),!0}catch(a){return!1}},get(t){try{const r=localStorage.getItem(t);if(null===r)return null;const i=JSON.parse(r);let n;return n=t===e.STORAGE_KEYS.APP_CONFIG?a.validateStorageData(i,"config"):t===e.STORAGE_KEYS.FASTING_DATA?a.validateStorageData(i,"fasting"):t===e.STORAGE_KEYS.CACHE?a.validateStorageData(i,"cache"):a.validateStorageData(i,"unknown"),n.valid?n.data:null}catch(r){return null}},remove(t){try{return localStorage.removeItem(t),!0}catch(e){return!1}},clear(){try{return Object.values(e.STORAGE_KEYS).forEach(t=>localStorage.removeItem(t)),!0}catch(t){return!1}},exportData(){try{return{app_config:this.get(e.STORAGE_KEYS.APP_CONFIG),puasa_ayyamul_bidh:this.get(e.STORAGE_KEYS.FASTING_DATA),exported_at:(new Date).toISOString()}}catch(t){return null}},importData(t){try{if(t.app_config){const r=a.validateStorageData(t.app_config,"config");r.valid&&this.save(e.STORAGE_KEYS.APP_CONFIG,r.data)}if(t.puasa_ayyamul_bidh){const r=a.validateStorageData(t.puasa_ayyamul_bidh,"fasting");r.valid&&this.save(e.STORAGE_KEYS.FASTING_DATA,r.data)}return!0}catch(r){return!1}},isCacheValid(t,a){const r=(this.get(e.STORAGE_KEYS.CACHE)||{})[t];return!(!r||!r.timestamp)&&(new Date).getTime()-r.timestamp<a},saveCache(t,a){const r=this.get(e.STORAGE_KEYS.CACHE)||{};r[t]={data:a,timestamp:(new Date).getTime()},this.save(e.STORAGE_KEYS.CACHE,r)},getCache(t){const a=(this.get(e.STORAGE_KEYS.CACHE)||{})[t];return a?a.data:null}}),i=t("U",{formatDate:(t,e="long")=>new Intl.DateTimeFormat("id-ID",{short:{day:"numeric",month:"numeric",year:"numeric"},long:{weekday:"long",day:"numeric",month:"long",year:"numeric"},iso:{year:"numeric",month:"2-digit",day:"2-digit"}}[e]).format(t),formatTime:t=>t&&"string"==typeof t?t.substring(0,5):"--:--",getCurrentDate:()=>new Date,addDays(t,e){const a=new Date(t);return a.setDate(a.getDate()+e),a},diffDays(t,e){const a=Math.abs(e-t);return Math.round(a/864e5)},sanitizeHTML(t){if("string"!=typeof t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML},sanitizeInput(t){return this.sanitizeHTML(t)},validateCoordinates(t,e){const a=parseFloat(t),r=parseFloat(e);return isNaN(a)||isNaN(r)?{valid:!1,error:"Koordinat harus berupa angka"}:a<-90||a>90?{valid:!1,error:"Latitude harus antara -90 dan 90"}:r<-180||r>180?{valid:!1,error:"Longitude harus antara -180 dan 180"}:{valid:!0,latitude:a,longitude:r}},throttle(t,e){let a=0;return function(...r){const i=(new Date).getTime();if(!(i-a<e))return a=i,t(...r)}},debounce(t,e){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>t.apply(this,r),e)}},formatDateForAPI:t=>`${String(t.getDate()).padStart(2,"0")}-${String(t.getMonth()+1).padStart(2,"0")}-${t.getFullYear()}`,calculateCountdown(t){if(!t)return"";const e=new Date,[a,r]=t.split(":").map(Number),i=new Date;i.setHours(a,r,0,0),i<e&&i.setDate(i.getDate()+1);const n=i-e,s=Math.floor(n/36e5),o=Math.floor(n%36e5/6e4);return s>0?`${s} jam ${o} menit`:`${o} menit`},isOnline:()=>navigator.onLine,showToast(t,e="info"){const a={success:"bg-success text-white",error:"bg-danger text-white",warning:"bg-warning text-dark",info:"bg-info text-white"},r=a[e]||a.info;let i=document.getElementById("toastContainer");i||(i=document.createElement("div"),i.id="toastContainer",i.className="toast-container position-fixed bottom-0 end-0 p-3",i.style.zIndex="9999",document.body.appendChild(i));const n=`toast-${Date.now()}`,s=document.createElement("div");s.id=n,s.className=`toast ${r}`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true");const o=document.createElement("div");o.className="toast-body d-flex justify-content-between align-items-center";const h=document.createElement("span");h.textContent=t;const l=document.createElement("button");l.type="button",l.className="btn-close btn-close-white",l.setAttribute("data-bs-dismiss","toast"),l.setAttribute("aria-label","Close"),o.appendChild(h),o.appendChild(l),s.appendChild(o),i.appendChild(s),new bootstrap.Toast(s,{autohide:!0,delay:5e3}).show(),s.addEventListener("hidden.bs.toast",()=>{s.remove()})},downloadJSON(t,e="data.json"){const a=JSON.stringify(t,null,2),r=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(r),n=document.createElement("a");n.href=i,n.download=e,n.click(),URL.revokeObjectURL(i)},parseJSONFile:async t=>new Promise((e,a)=>{const r=new FileReader;r.onload=t=>{try{const a=JSON.parse(t.target.result);e(a)}catch(r){a(new Error("File JSON tidak valid"))}},r.onerror=()=>a(new Error("Gagal membaca file")),r.readAsText(t)}),hijriMonthNames:["Muharram","Safar","Rabiul Awal","Rabiul Akhir","Jumadil Awal","Jumadil Akhir","Rajab","Sha'ban","Ramadan","Syawal","Dzulqa'dah","Dzulhijjah"],getHijriMonthName(t){return this.hijriMonthNames[t-1]||""},dayNames:["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],getDayName(t){return this.dayNames[t]||""},getIndonesianTimezone(){const t=-(new Date).getTimezoneOffset()/60;return 7===t?"WIB":8===t?"WITA":9===t?"WIT":"WIB"}});class n{constructor(t=e.API.BASE_URL){this.baseURL=t,this.defaultMethod=e.API.DEFAULT_METHOD}async _fetchFromAPI(t){const e=await fetch(t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const a=await e.json();if(200!==a.code)throw new Error("API error: "+a.status);return a}_buildUrlWithMethodParams(t,a){let r=`${t}&method=${a}`;if(99===a){const t=e.API.KEMENAG_CUSTOM;r+=`&methodSettings=${t.methodSettings}`,r+=`&tune=${t.tune}`}return r}async getTimingsByCity(t,e,a=this.defaultMethod,r=null){try{const n=r||i.formatDateForAPI(new Date),s=`${this.baseURL}/timingsByCity/${n}?city=${encodeURIComponent(t)}&country=${encodeURIComponent(e)}`,o=this._buildUrlWithMethodParams(s,a),h=await this._fetchFromAPI(o);return this.parseTimingsData(h.data)}catch(n){throw n}}async getTimingsByCoordinates(t,e,a=this.defaultMethod,r=null){try{const n=r||i.formatDateForAPI(new Date),s=`${this.baseURL}/timings/${n}?latitude=${t}&longitude=${e}`,o=this._buildUrlWithMethodParams(s,a),h=await this._fetchFromAPI(o);return this.parseTimingsData(h.data)}catch(n){throw n}}async getMonthlyCalendar(t,e,a,r,i=this.defaultMethod){try{const n=`${this.baseURL}/calendarByCity/${a}/${r}?city=${encodeURIComponent(t)}&country=${encodeURIComponent(e)}`,s=this._buildUrlWithMethodParams(n,i);return(await this._fetchFromAPI(s)).data.map(t=>this.parseTimingsData(t))}catch(n){throw n}}async getMonthlyCalendarByCoordinates(t,e,a,r,i=this.defaultMethod){try{const n=`${this.baseURL}/calendar/${a}/${r}?latitude=${t}&longitude=${e}`,s=this._buildUrlWithMethodParams(n,i);return(await this._fetchFromAPI(s)).data.map(t=>this.parseTimingsData(t))}catch(n){throw n}}parseTimingsData(t){const e=a.validateDateData(t.date);e.valid;const r=a.validatePrayerTimings(t.timings);if(!r.valid)throw new Error("Invalid prayer timings from API: "+r.error);const i=e.data||t.date,n=r.data;return{date:{gregorian:i.gregorian?.date||t.date.gregorian.date,hijri:i.hijri?.date||t.date.hijri.date,readable:i.readable||t.date.readable,gregorianDay:i.gregorian?.day||t.date.gregorian.day,gregorianMonth:i.gregorian?.month||t.date.gregorian.month.en,gregorianYear:i.gregorian?.year||t.date.gregorian.year,hijriDay:i.hijri?.day||t.date.hijri.day,hijriMonth:i.hijri?.month?.en||t.date.hijri.month.en,hijriMonthAr:i.hijri?.month?.ar||t.date.hijri.month.ar,hijriMonthNumber:i.hijri?.month?.number||t.date.hijri.month.number,hijriYear:i.hijri?.year||t.date.hijri.year},timings:n}}async getPrayerTimesWithCache(t,a=this.defaultMethod){const i=`prayer_times_${JSON.stringify(t)}`,n=e.CACHE.PRAYER_TIMES_MAX_AGE;if(r.isCacheValid(i,n))return r.getCache(i);let s;try{if(t.city&&t.country)s=await this.getTimingsByCity(t.city,t.country,a);else{if(!t.latitude||!t.longitude)throw new Error("Invalid location data");s=await this.getTimingsByCoordinates(t.latitude,t.longitude,a)}return r.saveCache(i,s),s}catch(o){const t=r.getCache(i);if(t)return t;throw o}}getNextPrayerTime(t){const e=new Date,a=60*e.getHours()+e.getMinutes(),r=[{name:"Subuh",time:t.Fajr},{name:"Dzuhur",time:t.Dhuhr},{name:"Ashar",time:t.Asr},{name:"Maghrib",time:t.Maghrib},{name:"Isya",time:t.Isha}];for(const n of r){const[t,e]=n.time.split(":").map(Number);if(60*t+e>a)return{name:n.name,time:i.formatTime(n.time),countdown:i.calculateCountdown(n.time)}}return{name:"Subuh",time:i.formatTime(t.Fajr),countdown:i.calculateCountdown(t.Fajr)}}getCurrentPrayerTime(t){const e=new Date,a=60*e.getHours()+e.getMinutes(),r=[{name:"Subuh",start:t.Fajr,end:t.Sunrise},{name:"Dzuhur",start:t.Dhuhr,end:t.Asr},{name:"Ashar",start:t.Asr,end:t.Maghrib},{name:"Maghrib",start:t.Maghrib,end:t.Isha},{name:"Isya",start:t.Isha,end:"23:59"}];for(const i of r){const[t,e]=i.start.split(":").map(Number),[r,n]=i.end.split(":").map(Number);if(a>=60*t+e&&a<60*r+n)return i.name}return null}static getCalculationMethods(){return e.PRAYER_METHODS}}t("P",n);class s{constructor(t={}){this.queue=[],this.processing=!1,this.maxConcurrent=t.maxConcurrent||3,this.delayBetweenRequests=t.delay||150,this.activeRequests=0,this.retryAttempts=t.retryAttempts||2,this.retryDelay=t.retryDelay||1e3}async enqueue(t,e=0){return new Promise((a,r)=>{this.queue.push({fn:t,resolve:a,reject:r,priority:e,attempts:0}),this.queue.sort((t,e)=>e.priority-t.priority),this.processing||this.processQueue()})}async processQueue(){if(!this.processing){for(this.processing=!0;this.queue.length>0||this.activeRequests>0;){for(;this.activeRequests>=this.maxConcurrent;)await this.delay(50);if(0===this.queue.length){if(0===this.activeRequests)break;await this.delay(50);continue}const t=this.queue.shift();this.activeRequests++,this.executeWithRetry(t).then(t.resolve).catch(t.reject).finally(()=>{this.activeRequests--}),this.queue.length>0&&await this.delay(this.delayBetweenRequests)}this.processing=!1}}async executeWithRetry(t){try{return await t.fn()}catch(e){if((e.message.includes("429")||e.message.includes("Too Many Requests"))&&t.attempts<this.retryAttempts){t.attempts++;const e=this.retryDelay*Math.pow(2,t.attempts-1);return await this.delay(e),this.executeWithRetry(t)}throw e}}delay(t){return new Promise(e=>setTimeout(e,t))}clear(){this.queue=[]}getStatus(){return{queued:this.queue.length,active:this.activeRequests,processing:this.processing}}}class o{static gregorianToHijri(t){const e=new Date(622,6,16),a=t.getTime()-e.getTime(),r=Math.floor(a/864e5),i=354.36667;let n=Math.floor(r/i)+1,s=1,o=r-Math.floor((n-1)*i);const h=[30,29,30,29,30,29,30,29,30,29,30,29];for(;o>h[s-1]&&s<12;)o-=h[s-1],s++;const l=Math.ceil(o);return l<=0&&(s--,s<=0&&(s=12,n--)),{day:Math.max(1,Math.min(30,l)),month:s,year:n,monthName:this.getMonthName(s),calculated:!0,accuracy:"approximate"}}static getMonthName(t){return["Muharram","Safar","Rabi' al-Awwal","Rabi' al-Thani","Jumada al-Ula","Jumada al-Akhirah","Rajab","Sha'ban","Ramadan","Shawwal","Dhu al-Qi'dah","Dhu al-Hijjah"][t-1]||"Unknown"}static isAyyamulBidh(t){return t>=13&&t<=15}}class h{constructor(t=e.API.BASE_URL){this.baseURL=t,this.AYYAMUL_BIDH_DATES=e.AYYAMUL_BIDH.DATES,this.requestQueue=new s({maxConcurrent:3,delay:300,retryAttempts:2,retryDelay:1e3})}async gregorianToHijri(t){const e=`hijri_${t}`,i=r.getCache(e);if(i)return i;try{const i=await this.requestQueue.enqueue(async()=>{const e=`${this.baseURL}/gToH/${t}`,a=await fetch(e);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();if(200!==r.code)throw new Error("API error: "+r.status);return r}),n=a.validateHijriDate({day:i.data.hijri.day,month:i.data.hijri.month.number,monthName:i.data.hijri.month.en,year:i.data.hijri.year,formatted:`${i.data.hijri.day} ${i.data.hijri.month.en} ${i.data.hijri.year} H`});if(!n.valid)throw new Error("Invalid Hijri date from API: "+n.error);const s={...n.data,monthNameAr:a.sanitizeString(i.data.hijri.month.ar)};return r.saveCache(e,s),s}catch(n){try{const[a,i,n]=t.split("-").map(Number),s=new Date(n,i-1,a),h=o.gregorianToHijri(s),l={day:h.day,month:h.month,monthName:h.monthName,year:h.year,formatted:`${h.day} ${h.monthName} ${h.year} H`,monthNameAr:"",isFallback:!0};return r.saveCache(e,l),l}catch(s){throw n}}}async hijriToGregorian(t){const e=`gregorian_${t}`,i=r.getCache(e);if(i)return i;try{const i=await this.requestQueue.enqueue(async()=>{const e=`${this.baseURL}/hToG/${t}`,a=await fetch(e);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();if(200!==r.code)throw new Error("API error: "+r.status);return r}),n={day:parseInt(i.data.gregorian.day),month:parseInt(i.data.gregorian.month.number),monthName:a.sanitizeString(i.data.gregorian.month.en),year:parseInt(i.data.gregorian.year),formatted:a.sanitizeString(i.data.gregorian.date)};return r.saveCache(e,n),n}catch(n){throw n}}async getCurrentHijriDate(){const t=new Date,e=i.formatDateForAPI(t);return await this.gregorianToHijri(e)}async getAyyamulBidhDates(t,e){const a=[];for(const i of this.AYYAMUL_BIDH_DATES){const n=`${String(i).padStart(2,"0")}-${String(t).padStart(2,"0")}-${e}`;try{const r=await this.hijriToGregorian(n);a.push({hijriDay:i,hijriMonth:t,hijriYear:e,gregorianDate:new Date(r.year,r.month-1,r.day),formatted:r.formatted})}catch(r){}}return a}isAyyamulBidhDay(t){return this.AYYAMUL_BIDH_DATES.includes(t.day)}calculateDaysUntilNextAyyamulBidh(t){const e=t.day;if(e<13){const t=13-e;return{daysUntil:t,nextDate:13,status:"upcoming",message:`ðŸŒ™ Tinggal ${t} hari lagi menuju Ayyamul Bidh bulan ini!`}}if(e>=13&&e<=15)return{daysUntil:0,nextDate:e,status:"current",message:`âœ¨ HARI INI PUASA AYYAMUL BIDH! (${e} ${t.monthName} ${t.year} H)`};{const t=30-e+13;return{daysUntil:t,nextDate:13,status:"next_month",message:`ðŸ“… Ayyamul Bidh bulan depan dalam ${t} hari lagi`}}}generateMonthlyCalendarInstant(t,e){const a=[],r=new Date(e,t,0).getDate();for(let i=1;i<=r;i++){const r=new Date(e,t-1,i),n=o.gregorianToHijri(r);a.push({gregorianDay:i,gregorianMonth:t,gregorianYear:e,hijriDay:n.day,hijriMonth:n.month,hijriYear:n.year,hijriMonthName:n.monthName,isAyyamulBidh:this.AYYAMUL_BIDH_DATES.includes(n.day),isApproximate:!0})}return a}async generateMonthlyCalendar(t,e,a=!1){const r=[];if(a)for(let n=1;n<=30;n++){const a=`${String(n).padStart(2,"0")}-${String(t).padStart(2,"0")}-${e}`;try{const i=await this.hijriToGregorian(a);r.push({hijriDay:n,hijriMonth:t,hijriYear:e,gregorianDay:i.day,gregorianMonth:i.month,gregorianYear:i.year,isAyyamulBidh:this.AYYAMUL_BIDH_DATES.includes(n)})}catch(i){break}}else{const a=new Date(e,t,0).getDate(),i=[];for(let r=1;r<=a;r++){const a=`${String(r).padStart(2,"0")}-${String(t).padStart(2,"0")}-${e}`;i.push(this.gregorianToHijri(a).then(a=>({gregorianDay:r,gregorianMonth:t,gregorianYear:e,hijriDay:a.day,hijriMonth:a.month,hijriYear:a.year,hijriMonthName:a.monthName,isAyyamulBidh:this.AYYAMUL_BIDH_DATES.includes(a.day),isFallback:a.isFallback||!1})).catch(t=>null))}const n=await Promise.all(i);r.push(...n.filter(t=>null!==t))}return r}getHijriMonthName(t){return i.getHijriMonthName(t)}async getUpcomingAyyamulBidh(t=3){const e=[],a=await this.getCurrentHijriDate();for(let r=0;r<t;r++){let t=a.month+r,i=a.year;t>12&&(t-=12,i+=1);const n=await this.getAyyamulBidhDates(t,i);e.push({hijriMonth:t,hijriMonthName:this.getHijriMonthName(t),hijriYear:i,dates:n})}return e}}t("H",h);class l{constructor(){this.storageKey=e.STORAGE_KEYS.FASTING_DATA,this.loadData()}loadData(){this.data=r.get(this.storageKey)||{}}saveData(){r.save(this.storageKey,this.data)}getMonthKey(t,e){return`${e}-${String(t).padStart(2,"0")}`}markFasting(t,a,r){if(!e.AYYAMUL_BIDH.DATES.includes(t))return!1;const i=this.getMonthKey(a,r);return this.data[i]||(this.data[i]=[]),!this.data[i].includes(t)&&(this.data[i].push(t),this.data[i].sort(),this.saveData(),!0)}unmarkFasting(t,e,a){const r=this.getMonthKey(e,a);if(!this.data[r])return!1;const i=this.data[r].indexOf(t);return i>-1&&(this.data[r].splice(i,1),0===this.data[r].length&&delete this.data[r],this.saveData(),!0)}toggleFasting(t,e,a){return this.isFastingMarked(t,e,a)?(this.unmarkFasting(t,e,a),!1):(this.markFasting(t,e,a),!0)}isFastingMarked(t,e,a){const r=this.getMonthKey(e,a);return!!this.data[r]&&this.data[r].includes(t)}getMonthlyStats(t,e){const a=this.getMonthKey(t,e),r=this.data[a]||[],n=r.length,s=3===n,o=Math.round(n/3*100);return{month:t,monthName:i.getHijriMonthName(t),year:e,markedDays:r,totalDays:n,isComplete:s,percentage:o,status:3===n?"complete":n>0?"partial":"none"}}getYearlyStats(t){let e=0,a=0,r=0;const i=[];for(let n=1;n<=12;n++){const s=this.getMonthlyStats(n,t);i.push(s),e+=s.totalDays,s.isComplete?a++:s.totalDays>0&&r++}return{year:t,totalDays:e,maxPossibleDays:36,percentage:Math.round(e/36*100),completeMonths:a,partialMonths:r,emptyMonths:12-a-r,monthlyDetails:i}}getTotalFastingDays(){let t=0;for(const e in this.data)t+=this.data[e].length;return t}getCurrentStreak(t,a){let r=0,i=t-1,n=a;for(;(i<1&&(i=12,n--),this.getMonthlyStats(i,n).isComplete)&&(r++,i--,!(r>=e.VALIDATION.MAX_STREAK_CALCULATION)););return r}getLongestStreak(){const t=Object.keys(this.data).filter(t=>3===this.data[t].length).sort();if(0===t.length)return 0;let e=1,a=1;for(let r=1;r<t.length;r++){const[i,n]=t[r-1].split("-").map(Number),[s,o]=t[r].split("-").map(Number);s===i&&o===n+1||s===i+1&&12===n&&1===o?(a++,e=Math.max(e,a)):a=1}return e}getFastingHistory(){const t=[];for(const e in this.data){const[a,r]=e.split("-").map(Number);t.push({monthKey:e,month:r,monthName:i.getHijriMonthName(r),year:a,days:this.data[e],...this.getMonthlyStats(r,a)})}return t.sort((t,e)=>t.year!==e.year?e.year-t.year:e.month-t.month),t}exportHistory(){return{puasa_ayyamul_bidh:this.data,exported_at:(new Date).toISOString(),total_days:this.getTotalFastingDays(),longest_streak:this.getLongestStreak()}}importHistory(t){try{if(t.puasa_ayyamul_bidh){const e=a.validateStorageData(t.puasa_ayyamul_bidh,"fasting");return!!e.valid&&(this.data=a.deepClone(e.data),this.saveData(),!0)}return!1}catch(e){return!1}}resetAll(){this.data={},this.saveData()}}t("F",l);class d{constructor(){this.prayerTimesAPI=new n,this.hijriCalendar=new h,this.tracker=new l,this.config=null,this.currentData={todayDate:null,prayerTimes:null,hijriDate:null,ayyamulBidhInfo:null},this.intervals=[],this.clockInterval=null}async init(){try{this.config=r.get(e.STORAGE_KEYS.APP_CONFIG),this.config&&this.config.first_time_setup?await this.loadApp():await this.showSetupWizard()}catch(t){this.showError("Gagal menginisialisasi aplikasi")}}async showSetupWizard(){const t=document.getElementById("setupModal");t&&new bootstrap.Modal(t).show(),this.setupLocationFormListeners()}setupLocationFormListeners(){const t=document.getElementById("autoDetectLocation");t&&t.addEventListener("click",()=>this.autoDetectLocation());const e=document.getElementById("setupForm");e&&e.addEventListener("submit",t=>{t.preventDefault(),this.saveLocationFromForm()})}autoDetectLocation(){if(!navigator.geolocation)return void this.showError("Browser Anda tidak mendukung deteksi lokasi");const t=document.getElementById("locationStatus");t&&(t.textContent="Mendeteksi lokasi..."),navigator.geolocation.getCurrentPosition(async e=>{const a=e.coords.latitude,r=e.coords.longitude;await this.saveLocation({latitude:a,longitude:r,method:"gps"}),t&&(t.textContent="Lokasi terdeteksi!",t.className="text-success"),setTimeout(()=>this.completeSetup(),1e3)},e=>{this.showError("Gagal mendeteksi lokasi. Silakan pilih kota secara manual."),t&&(t.textContent="Gagal mendeteksi lokasi",t.className="text-danger")})}async saveLocationFromForm(){const t=document.getElementById("citySelect")?.value,e=document.getElementById("countryInput")?.value||"Indonesia";t?(await this.saveLocation({city:t,country:e,method:"manual"}),this.completeSetup()):this.showError("Pilih kota terlebih dahulu")}async saveLocation(t){this.config={location:t,prayer_method:e.API.DEFAULT_METHOD,first_time_setup:!0},r.save(e.STORAGE_KEYS.APP_CONFIG,this.config)}async completeSetup(){const t=document.getElementById("setupModal");if(t){const e=bootstrap.Modal.getInstance(t);e&&e.hide()}await this.loadApp()}async loadApp(){try{this.showLoading(!0),await Promise.all([this.loadTodayDate(),this.loadPrayerTimes()]),await this.loadHijriDate(),await this.loadAyyamulBidhInfo(),this.renderDashboard(),this.setupAutoUpdate(),this.setupClock(),this.showLoading(!1)}catch(t){this.showError("Gagal memuat data. Menggunakan data cache..."),this.showLoading(!1)}}async loadTodayDate(){this.currentData.todayDate=i.getCurrentDate()}async loadPrayerTimes(){try{const t=this.config.location,a=this.config.prayer_method||e.API.DEFAULT_METHOD;this.currentData.prayerTimes=await this.prayerTimesAPI.getPrayerTimesWithCache(t,a)}catch(t){i.showToast("Gagal memuat waktu sholat terbaru. Menggunakan data tersimpan.","warning")}}async loadHijriDate(){try{this.currentData.hijriDate=await this.hijriCalendar.getCurrentHijriDate()}catch(t){i.showToast("Gagal memuat tanggal Hijri. Periksa koneksi internet.","error")}}async loadAyyamulBidhInfo(){try{this.currentData.hijriDate?this.currentData.ayyamulBidhInfo=this.hijriCalendar.calculateDaysUntilNextAyyamulBidh(this.currentData.hijriDate):i.showToast("Informasi Ayyamul Bidh tidak dapat dimuat","warning")}catch(t){i.showToast("Gagal menghitung info Ayyamul Bidh","error")}}renderDashboard(){this.updateDateDisplay(),this.updatePrayerTimesDisplay(),this.updateAyyamulBidhDisplay(),this.updateStatsDisplay()}updateDateDisplay(){const t=document.getElementById("gregorianDate");t&&this.currentData.todayDate&&(t.textContent=i.formatDate(this.currentData.todayDate,"long"));const e=document.getElementById("hijriDate");e&&this.currentData.hijriDate&&(e.textContent=this.currentData.hijriDate.formatted)}updatePrayerTimesDisplay(){if(!this.currentData.prayerTimes)return;const t=this.currentData.prayerTimes.timings,e={fajrTime:t.Fajr,dhuhrTime:t.Dhuhr,asrTime:t.Asr,maghribTime:t.Maghrib,ishaTime:t.Isha,imsakTime:t.Imsak};for(const[s,o]of Object.entries(e)){const t=document.getElementById(s);t&&(t.textContent=i.formatTime(o))}const a=this.prayerTimesAPI.getNextPrayerTime(t),r=document.getElementById("nextPrayer");if(r&&a){r.textContent="";const t=document.createElement("strong");t.textContent=a.name;const e=document.createTextNode(` - ${a.time}`),i=document.createElement("br"),n=document.createElement("small");n.className="text-muted",n.textContent=`Akan tiba dalam ${a.countdown}`,r.appendChild(t),r.appendChild(e),r.appendChild(i),r.appendChild(n)}const n=this.prayerTimesAPI.getCurrentPrayerTime(t);if(n){document.querySelectorAll(".prayer-time-card").forEach(t=>{t.classList.remove("active-prayer")});const t=document.querySelector(`[data-prayer="${n.toLowerCase()}"]`);t&&t.classList.add("active-prayer")}}updateAyyamulBidhDisplay(){const t=document.getElementById("ayyamulBidhMessage"),e=document.getElementById("ayyamulBidhProgress");if(!this.currentData.ayyamulBidhInfo)return t&&(t.textContent="Informasi Ayyamul Bidh tidak tersedia. Silakan refresh halaman atau periksa koneksi internet.",t.className="alert alert-warning"),void(e&&(e.style.width="0%"));const a=this.currentData.ayyamulBidhInfo;t&&(t.textContent=a.message,"current"===a.status?t.className="alert alert-success fw-bold":t.className="alert alert-info");const r=document.getElementById("ayyamulBidhCountdown");if(r&&a.daysUntil>0&&(r.textContent=a.daysUntil),e&&this.currentData.hijriDate){const t=this.currentData.hijriDate.month,a=this.currentData.hijriDate.year,r=this.tracker.getMonthlyStats(t,a).totalDays,i=r/3*100;e.style.width=`${i}%`,e.setAttribute("aria-valuenow",i),e.textContent=`${r}/3 hari (${Math.round(i)}%)`}}updateStatsDisplay(){if(!this.currentData.hijriDate)return;const t=this.currentData.hijriDate.month,e=this.currentData.hijriDate.year,a=this.tracker.getMonthlyStats(t,e),r=document.getElementById("monthlyStats");r&&(r.textContent=`${a.totalDays}/3`);const i=this.tracker.getYearlyStats(e),n=document.getElementById("yearlyStats");n&&(n.textContent=`${i.totalDays}/36`);const s=this.tracker.getCurrentStreak(t,e),o=document.getElementById("currentStreak");o&&(o.textContent=`${s} bulan`)}setupAutoUpdate(){this.clearIntervals();const t=setInterval(()=>{this.updatePrayerTimesDisplay()},e.INTERVALS.PRAYER_COUNTDOWN_UPDATE);this.intervals.push(t);const a=setInterval(async()=>{await this.loadPrayerTimes(),this.updatePrayerTimesDisplay()},e.INTERVALS.DATA_REFRESH);this.intervals.push(a)}showLoading(t){const e=document.getElementById("loadingIndicator");e&&(e.style.display=t?"block":"none")}showError(t){i.showToast(t,"error")}clearIntervals(){this.intervals.forEach(t=>clearInterval(t)),this.intervals=[],this.clockInterval&&(clearInterval(this.clockInterval),this.clockInterval=null)}destroy(){this.clearIntervals()}setupClock(){this.clockInterval&&clearInterval(this.clockInterval),this.updateClock(),this.clockInterval=setInterval(()=>{this.updateClock()},e.INTERVALS.SECOND)}updateClock(){const t=document.getElementById("currentTime"),e=document.getElementById("currentTimezone");if(!t)return;const a=new Date,r=String(a.getHours()).padStart(2,"0"),n=String(a.getMinutes()).padStart(2,"0"),s=String(a.getSeconds()).padStart(2,"0");if(t.textContent=`${r}:${n}:${s}`,e){const t=i.getIndonesianTimezone();e.textContent=t}}async refresh(){await this.loadApp()}}document.addEventListener("DOMContentLoaded",()=>{(new d).init()}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("currentYear");if(t){const e=(new Date).getFullYear();t.textContent=e}}),window.addEventListener("beforeunload",()=>{window.app&&window.app.destroy()})}}});
